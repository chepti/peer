<script>
document.addEventListener('DOMContentLoaded', function() {
  const state = {
    currentUser: null
  };

  // --- DOM Elements ---
  const loginModal = document.getElementById('login-modal');
  const registerModal = document.getElementById('register-modal');
  const loginForm = document.getElementById('login-form');
  const registerForm = document.getElementById('register-form');
  const userActions = document.getElementById('user-actions');

  // --- Modal Management ---
  function setupModal(modal, openTriggers, closeTriggers) {
    const closeBtn = modal.querySelector('.close-btn');
    
    function openModal() { modal.classList.add('show'); }
    function closeModal() { modal.classList.remove('show'); }

    openTriggers.forEach(triggerId => {
      document.body.addEventListener('click', function(e) {
        if (e.target.id === triggerId) {
          e.preventDefault();
          openModal();
        }
      });
    });

    closeBtn.addEventListener('click', closeModal);
    closeTriggers.forEach(triggerId => {
        const el = document.getElementById(triggerId);
        if(el) el.addEventListener('click', (e) => { e.preventDefault(); closeModal(); });
    });
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });
  }

  setupModal(loginModal, ['login-btn-header', 'show-login'], []);
  setupModal(registerModal, ['show-register'], ['show-login']);

  document.getElementById('show-register').addEventListener('click', () => {
      loginModal.classList.remove('show');
      registerModal.classList.add('show');
  });
  document.getElementById('show-login').addEventListener('click', () => {
      registerModal.classList.remove('show');
      loginModal.classList.add('show');
  });

  // --- Authentication ---
  loginForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    // Show loading state
    google.script.run
      .withSuccessHandler(onAuthSuccess)
      .withFailureHandler(onAuthFailure)
      .loginUser(username, password);
  });
  
  registerForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const userData = {
        username: document.getElementById('register-username').value,
        fullName: document.getElementById('register-fullname').value,
        password: document.getElementById('register-password').value,
        securityQuestion: document.getElementById('register-security-question').value,
        securityAnswer: document.getElementById('register-security-answer').value,
      };
      // Show loading state
      google.script.run
        .withSuccessHandler(onAuthSuccess)
        .withFailureHandler(onAuthFailure)
        .registerUser(userData);
  });

  function onAuthSuccess(userString) {
      if (!userString) {
          onAuthFailure({message: "שם משתמש או סיסמה שגויים."});
          return;
      }
      const user = JSON.parse(userString);
      if (user.error) {
          onAuthFailure(user);
          return;
      }
      state.currentUser = user;
      updateUIForUser();
      loginModal.classList.remove('show');
      registerModal.classList.remove('show');
  }

  function onAuthFailure(error) {
      alert('שגיאת התחברות: ' + error.message);
      // Hide loading state
  }
  
  function updateUIForUser() {
      userActions.innerHTML = '';
      if(state.currentUser) {
          document.getElementById('nav-add-artifact').style.display = 'flex';
          document.getElementById('nav-reviews').style.display = 'flex';
          document.getElementById('nav-profile').style.display = 'flex';
          document.getElementById('nav-logout').style.display = 'flex';
          if(state.currentUser.isAdmin) {
              document.getElementById('nav-admin').style.display = 'flex';
          }
          
          const avatarInitial = state.currentUser.fullName.charAt(0);
          userActions.innerHTML = `
              <div id="user-info">
                  <span>${state.currentUser.fullName}</span>
                  <div id="user-avatar">${avatarInitial}</div>
              </div>
          `;
      } else {
          userActions.innerHTML = `<button id="login-btn-header">התחברות / הרשמה</button>`;
      }
  }

  // --- Initial Load ---
  function init() {
      updateUIForUser(); // Initially show login button
      // loadGallery();
  }

  init();
});

// Mock functions for now
// function loadGallery() {}
</script> 