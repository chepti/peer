<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- STATE ---
  let currentUser = null;
  let allArtifacts = [];
  
  // --- SELECTORS ---
  const pages = document.querySelectorAll('.page');
  const navLinks = {
    gallery: document.getElementById('nav-gallery'),
    upload: document.getElementById('nav-upload'),
    profile: document.getElementById('nav-profile'),
    admin: document.getElementById('nav-admin')
  };
  const loader = document.getElementById('loader');
  const userInfo = document.getElementById('user-info');
  const galleryContainer = document.getElementById('gallery-container');
  const uploadForm = document.getElementById('upload-form');
  const profileStats = document.getElementById('profile-stats');
  const profileArtifactsContainer = document.getElementById('profile-artifacts-container');
  const reviewAssignmentsContainer = document.getElementById('review-assignments-container');
  const navReview = document.createElement('a');
  navReview.href = '#';
  navReview.id = 'nav-review';
  navReview.textContent = '×”×¢×¨×›×ª ×¢××™×ª×™×';
  navReview.style.display = 'none'; // Hidden by default
  const loginModal = document.getElementById('login-modal');
  const loginButton = document.getElementById('login-button');
  const closeButton = document.querySelector('.close-button');
  const loginForm = document.getElementById('login-form');
  
  // Insert the new nav link
  navLinks.profile.parentNode.insertBefore(navReview, navLinks.admin);
  navLinks.review = navReview;

  // --- FUNCTIONS ---

  /**
   * Shows a specific page and hides all others.
   * @param {string} pageId The ID of the page to show.
   */
  const showPage = (pageId) => {
    pages.forEach(page => {
      page.style.display = page.id === pageId ? 'block' : 'none';
    });
    // Update active nav link
    for (const link in navLinks) {
        navLinks[link].classList.remove('active');
    }
    const activeLink = document.getElementById(`nav-${pageId.split('-')[1]}`);
    if (activeLink) {
        activeLink.classList.add('active');
    }
  };

  /**
   * Shows or hides the loader animation.
   * @param {boolean} show True to show, false to hide.
   */
  const showLoader = (show) => {
    const loader = document.getElementById('loader');
    if(loader) {
      loader.style.display = show ? 'block' : 'none';
    }
  };

  /**
   * Renders the artifacts in the gallery.
   * @param {Array<Object>} artifacts An array of artifact objects.
   */
  const renderGallery = (artifacts) => {
    galleryContainer.innerHTML = '';
    if (!artifacts || artifacts.length === 0) {
      galleryContainer.innerHTML = '<p>×œ× × ××¦××• ×ª×•×¦×¨×™×.</p>';
      return;
    }
    artifacts.forEach(artifact => {
      const card = document.createElement('div');
      card.className = 'artifact-card';
      card.innerHTML = `
        <div class="image-container">
            ${(artifact.previewImageUrl && artifact.previewImageUrl.startsWith('http')) 
              ? `<img src="${artifact.previewImageUrl}" alt="×ª×¦×•×’×” ××§×“×™××” ×©×œ ${artifact.title}" class="artifact-image" onerror="this.style.display='none'">` 
              : ''}
          </div>
        ${artifact.targetAudience ? `<div class="card-chip">${artifact.targetAudience}</div>` : ''}
        <div class="card-content">
          <h3>${artifact.title || '×œ×œ× ×›×•×ª×¨×ª'}</h3>
          <p><strong>×™×•×¦×¨/×ª:</strong> <a href="#" class="user-link" data-email="${artifact.submitterUsername}">${artifact.submitterUsername}</a></p>
          <p>${artifact.instructions || ''}</p>
          <p><strong><small>×›×œ×™:</small></strong> ${artifact.toolUsed || '×œ× ×¦×•×™×Ÿ'}</p>
          <div class="actions">
             <a href="${artifact.artifactLink}" target="_blank" class="icon-button" title="×¦×¤×” ×‘×ª×•×¦×¨">
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
             </a>
          </div>
        </div>
      `;
      galleryContainer.appendChild(card);
    });
  };

  /**
   * Initial application setup on page load.
   */
  const initializeApp = () => {
    showLoader(true);
    // In guest mode, we only load the gallery. No user data needed.
    loadGallery();
  };

  /**
   * Loads and displays the artifact gallery.
   */
  const loadGallery = () => {
    showPage('page-gallery');
    showLoader(true);
    google.script.run
      .withSuccessHandler(jsonString => {
        try {
          const artifacts = JSON.parse(jsonString);
          allArtifacts = artifacts;
          renderGallery(allArtifacts);
        } catch (e) {
          console.error("Failed to parse artifacts:", e);
          galleryContainer.innerHTML = '<p>×©×’×™××” ×‘×¢×™×‘×•×“ × ×ª×•× ×™ ×”×’×œ×¨×™×”.</p>';
        }
        showLoader(false);
      })
      .withFailureHandler(err => {
        console.error('Error loading gallery:', err);
        galleryContainer.innerHTML = `<p>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×’×œ×¨×™×”: ${err.message}</p>`;
        showLoader(false);
      })
      .getArtifacts();
  };
  
  /**
   * Loads the upload form.
   */
  const loadUploadPage = () => {
    showPage('page-upload');
    uploadForm.innerHTML = `
      <h2 id="upload-title">×”×¢×œ××ª ×ª×•×¦×¨ ×—×“×©</h2>
      <div class="form-group">
        <label for="title">×©× ×”×ª×•×¦×¨:</label>
        <input type="text" id="title" name="title" required>
      </div>
      
      <div class="form-group">
        <label for="instructions">×”×¡×‘×¨ ××™×š ×œ×”×©×ª××© ×‘×ª×•×¦×¨:</label>
        <textarea id="instructions" name="instructions" rows="4" required></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="targetAudience">×§×”×œ ×™×¢×“:</label>
          <input type="text" id="targetAudience" name="targetAudience" placeholder="×œ××©×œ: ×›×™×ª×” ×”'">
        </div>
        <div class="form-group">
          <label for="toolUsed">×›×œ×™ ×¢×‘×•×“×” ×©×©×™××© ×œ×™×¦×™×¨×”:</label>
          <input type="text" id="toolUsed" name="toolUsed" placeholder="×œ××©×œ: Genially">
        </div>
      </div>
      
      <div class="form-group">
        <label for="tags">×ª×’×™×•×ª (××•×¤×¨×“×•×ª ×‘×¤×¡×™×§):</label>
        <input type="text" id="tags" name="tags" placeholder="×œ××©×œ: ×’×™××•××˜×¨×™×”, ××©×—×§">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="artifactLink">×§×™×©×•×¨ ×œ×ª×•×¦×¨ (×× ×§×™×™×):</label>
          <input type="url" id="artifactLink" name="artifactLink" placeholder="https://example.com">
        </div>
        <div class="form-group">
          <label for="artifactFile">××•: ×”×¢×œ××ª ×§×•×‘×¥ ×ª×•×¦×¨:</label>
          <input type="file" id="artifactFile" name="artifactFile">
        </div>
      </div>
      
      <button type="submit">×©×œ×™×—×ª ×ª×•×¦×¨</button>
      <div id="upload-status"></div>
    `;
  };

  /**
   * Loads the user's profile page, showing their details and submitted artifacts.
   */
  const loadProfilePage = () => {
    if (!currentUser || !currentUser.token) {
      alert('×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×¦×¤×•×ª ×‘×¤×¨×•×¤×™×œ.');
      return;
    }
    showPage('page-profile');
    showLoader(true);
    profileArtifactsContainer.innerHTML = '';
    profileStats.innerHTML = '';

    google.script.run
      .withSuccessHandler(jsonString => {
        try {
          const data = JSON.parse(jsonString);
          profileStats.innerHTML = `
            <p><strong>××¡×¤×¨ ×ª×•×¦×¨×™× ×©×”×¢×œ×™×ª:</strong> ${data.artifacts.length}</p>
            <p><strong>××¡×¤×¨ ×”×¢×¨×›×•×ª ×©×‘×™×¦×¢×ª:</strong> ${data.reviewCount}</p>
          `;

          if (data.artifacts.length === 0) {
            profileArtifactsContainer.innerHTML = '<p>×¢×“×™×™×Ÿ ×œ× ×”×¢×œ×™×ª ×ª×•×¦×¨×™×.</p>';
          } else {
            renderProfileArtifacts(data.artifacts);
          }
        } catch (e) {
          console.error("Failed to parse profile data:", e);
          profileArtifactsContainer.innerHTML = '<p>×©×’×™××” ×‘×¢×™×‘×•×“ × ×ª×•× ×™ ×”×¤×¨×•×¤×™×œ.</p>';
        }
        showLoader(false);

        // Check for review assignments after profile loads
        google.script.run
          .withSuccessHandler(assignString => {
            const assignments = JSON.parse(assignString);
            if (assignments && assignments.length > 0) {
              navLinks.review.style.display = 'inline-block';
            } else {
              navLinks.review.style.display = 'none';
            }
          })
          .getReviewAssignments();
      })
      .withFailureHandler(err => {
        console.error('Error loading profile:', err);
        profileArtifactsContainer.innerHTML = `<p>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¤×¨×•×¤×™×œ: ${err.message}</p>`;
        showLoader(false);
      })
      .getUserProfileData();
  };
  
  /**
   * Loads the peer review assignment page.
   */
  const loadReviewPage = () => {
    showPage('page-review');
    showLoader(true);
    reviewAssignmentsContainer.innerHTML = '';
    google.script.run
      .withSuccessHandler(jsonString => {
        try {
          const assignments = JSON.parse(jsonString);
          if (!assignments || assignments.length === 0) {
            const navReview = document.getElementById('nav-review');
            if(navReview) navReview.style.display = 'none';
            reviewAssignmentsContainer.innerHTML = '<p>××™×Ÿ ×œ×š ××©×™××•×ª ×”×¢×¨×›×” ×›×¨×’×¢. × ×”×“×¨!</p>';
          } else {
            renderReviewAssignments(assignments);
          }
        } catch (e) {
          console.error("Failed to parse review assignments:", e);
          reviewAssignmentsContainer.innerHTML = '<p>×©×’×™××” ×‘×¢×™×‘×•×“ ××©×™××•×ª ×”×”×¢×¨×›×”.</p>';
        }
        showLoader(false);
      })
      .withFailureHandler(err => {
        reviewAssignmentsContainer.innerHTML = `<p>×©×’×™××” ×‘×˜×¢×™× ×ª ××©×™××•×ª: ${err.message}</p>`;
        showLoader(false);
      })
      .getReviewAssignments();
  };

  /**
   * Loads the admin dashboard.
   */
  const loadAdminPage = () => {
    if (!currentUser || !currentUser.user.isAdmin) {
       alert('× ×“×¨×©×•×ª ×”×¨×©××•×ª ×× ×”×œ.');
       return;
    }
    showPage('page-admin');
    showLoader(true);
    google.script.run
      .withSuccessHandler(data => {
        renderAdminPage(data);
        showLoader(false);
      })
      .withFailureHandler(err => {
        mainContent.innerHTML = `<p class="error">×©×’×™××” ×‘×˜×¢×™× ×ª ×“×£ ×× ×”×œ: ${err.message}</p>`;
        showLoader(false);
      })
      .getAdminDashboardData(currentUser.token);
  };

  // --- HELPER RENDER FUNCTIONS ---
  const renderProfileArtifacts = (artifacts) => {
      artifacts.forEach(artifact => {
        const card = document.createElement('div');
        card.className = 'artifact-card';
        card.innerHTML = `
          <div class="image-container">
            ${(artifact.previewImageUrl && artifact.previewImageUrl.startsWith('http')) 
              ? `<img src="${artifact.previewImageUrl}" alt="×ª×¦×•×’×” ××§×“×™××” ×©×œ ${artifact.title}" class="artifact-image" onerror="this.style.display='none'">` 
              : ''}
          </div>
          ${artifact.targetAudience ? `<div class="card-chip">${artifact.targetAudience}</div>` : ''}
          <div class="card-content">
            <h3>${artifact.title}</h3>
            <p>${artifact.instructions}</p>
            <p><strong><small>×›×œ×™:</small></strong> ${artifact.toolUsed || '×œ× ×¦×•×™×Ÿ'}</p>
            <div class="actions">
              <a href="${artifact.artifactLink}" target="_blank" class="icon-button" title="×¦×¤×” ×‘×ª×•×¦×¨">
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
              </a>
              <button class="icon-button edit-btn" data-id="${artifact.id}" title="×¢×¨×•×š">
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M14.06 9.02l.92.92L5.92 19H5v-.92l9.06-9.06M17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29zm-3.6 3.19L3 17.25V21h3.75L17.81 9.94l-3.75-3.75z"/></svg>
              </button>
              <button class="icon-button delete-btn" data-id="${artifact.id}" title="××—×§">
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/></svg>
              </button>
            </div>
          </div>
        `;
        profileArtifactsContainer.appendChild(card);
        card.querySelector('.edit-btn').addEventListener('click', () => handleEditArtifactClick(artifact.id));
        card.querySelector('.delete-btn').addEventListener('click', () => deleteArtifact(artifact.id));
      });
  };

  const renderReviewAssignments = (assignments) => {
      assignments.forEach(artifact => {
        const assignmentCard = document.createElement('div');
        assignmentCard.className = 'artifact-card review-assignment';
        const artifactId = artifact.id; // Unique ID for form elements

        assignmentCard.innerHTML = `
          <h3>×”×¢×¨×›×ª ×”×ª×•×¦×¨: ${artifact.title}</h3>
          <p><strong>×”×•×¨××•×ª:</strong> ${artifact.instructions}</p>
          <a href="${artifact.artifactLink}" target="_blank">×¤×ª×— ××ª ×”×ª×•×¦×¨ ×‘×—×œ×•×Ÿ ×—×“×©</a>
          <form class="review-form" data-artifact-id="${artifactId}">
            <h4>×“×™×¨×•×’:</h4>
            
            <div class="rating-group">
              <label title="×¢×™×¦×•×‘ ×”×ª×•×¦×¨ ×ª×•×¨× ×œ×”×‘× ×”, ××•×¡×™×£ ×—×™×•×ª ×•×¢× ×™×™×Ÿ">××™×›×•×ª ×”×¢×™×¦×•×‘:</label>
              <div class="star-rating">
                <input type="radio" id="design-5-${artifactId}" name="scoreDesign" value="5" required><label for="design-5-${artifactId}">â˜…</label>
                <input type="radio" id="design-4-${artifactId}" name="scoreDesign" value="4"><label for="design-4-${artifactId}">â˜…</label>
                <input type="radio" id="design-3-${artifactId}" name="scoreDesign" value="3"><label for="design-3-${artifactId}">â˜…</label>
                <input type="radio" id="design-2-${artifactId}" name="scoreDesign" value="2"><label for="design-2-${artifactId}">â˜…</label>
                <input type="radio" id="design-1-${artifactId}" name="scoreDesign" value="1"><label for="design-1-${artifactId}">â˜…</label>
              </div>
            </div>

            <div class="rating-group">
              <label title="× ×™×¦×•×œ × ×‘×•×Ÿ ×©×œ ×™×›×•×œ×•×ª ×”×›×œ×™ ×”×˜×›× ×•×œ×•×’×™, ×•×”×ª×××” ×©×œ×• ×œ×¦×•×¨×š ×”××“×•×™×§">×©×™××•×© × ×›×•×Ÿ ×‘×˜×›× ×•×œ×•×’×™×”:</label>
              <div class="star-rating">
                <input type="radio" id="tech-5-${artifactId}" name="scoreTechnical" value="5" required><label for="tech-5-${artifactId}">â˜…</label>
                <input type="radio" id="tech-4-${artifactId}" name="scoreTechnical" value="4"><label for="tech-4-${artifactId}">â˜…</label>
                <input type="radio" id="tech-3-${artifactId}" name="scoreTechnical" value="3"><label for="tech-3-${artifactId}">â˜…</label>
                <input type="radio" id="tech-2-${artifactId}" name="scoreTechnical" value="2"><label for="tech-2-${artifactId}">â˜…</label>
                <input type="radio" id="tech-1-${artifactId}" name="scoreTechnical" value="1"><label for="tech-1-${artifactId}">â˜…</label>
              </div>
            </div>

            <div class="rating-group">
              <label title="×”×ª×•×›×Ÿ ×‘×¨××” ××ª××™××”, ×ª×•×¨× ×‘××•×¤×Ÿ ××©××¢×•×ª×™ ×œ×”×§× ×™×” ××• ×œ×ª×¨×’×•×œ ×©×œ ×”×—×•××¨ ×”× ×œ××“">××™×›×•×ª ×¤×“×’×•×’×™×ª:</label>
              <div class="star-rating">
                <input type="radio" id="ped-5-${artifactId}" name="scorePedagogy" value="5" required><label for="ped-5-${artifactId}">â˜…</label>
                <input type="radio" id="ped-4-${artifactId}" name="scorePedagogy" value="4"><label for="ped-4-${artifactId}">â˜…</label>
                <input type="radio" id="ped-3-${artifactId}" name="scorePedagogy" value="3"><label for="ped-3-${artifactId}">â˜…</label>
                <input type="radio" id="ped-2-${artifactId}" name="scorePedagogy" value="2"><label for="ped-2-${artifactId}">â˜…</label>
                <input type="radio" id="ped-1-${artifactId}" name="scorePedagogy" value="1"><label for="ped-1-${artifactId}">â˜…</label>
              </div>
            </div>

            <div class="form-group">
              <label for="comments-${artifactId}">×”×¢×¨×” (×œ× ×—×•×‘×”):</label>
              <textarea name="comments" id="comments-${artifactId}" rows="3"></textarea>
            </div>
            <button type="submit">×©×œ×— ×”×¢×¨×›×”</button>
          </form>
        `;
        reviewAssignmentsContainer.appendChild(assignmentCard);
      });
  };

  const renderAdminDashboard = (data) => {
    const container = document.getElementById('admin-content');
    if (!container) return;
    container.innerHTML = '';

    // Users Table
    let usersHtml = `<h3>×¡×™×›×•× ××©×ª××©×™×</h3><table class="admin-table">
        <thead><tr><th>××™×™×œ</th><th>×”×’×©×•×ª</th><th>×”×¢×¨×›×•×ª</th><th>×–×›××•×ª</th></tr></thead><tbody>`;
    data.usersReport.forEach(user => {
        usersHtml += `<tr>
            <td>${user.username}</td>
            <td>${user.submissionsCount || 0}</td>
            <td>${user.reviewsCompletedCount || 0}</td>
            <td>${user.isEligible ? '×›×Ÿ' : '×œ×'}</td>
        </tr>`;
    });
    usersHtml += '</tbody></table>';

    // Artifacts Table
    let artifactsHtml = `<h3 style="margin-top: 30px;">×¡×™×›×•× ×ª×•×¦×¨×™×</h3><table class="admin-table">
        <thead><tr><th>×ª×•×¦×¨</th><th>×™×•×¦×¨/×ª</th><th>××¡' ×”×¢×¨×›×•×ª</th><th>×××•×¦×¢ ×¢×™×¦×•×‘</th><th>×××•×¦×¢ ×˜×›× ×™</th><th>×××•×¦×¢ ×¤×“×’×•×’×™</th></tr></thead><tbody>`;
    data.artifactsReport.forEach(artifact => {
        artifactsHtml += `<tr>
            <td>${artifact.title}</td>
            <td>${artifact.submitter}</td>
            <td>${artifact.reviewCount}</td>
            <td>${artifact.avgDesign}</td>
            <td>${artifact.avgTech}</td>
            <td>${artifact.avgPedagogy}</td>
        </tr>`;
    });
    artifactsHtml += '</tbody></table>';

    container.innerHTML = usersHtml + artifactsHtml;
  };

  // --- EVENT LISTENERS ---
  loginButton.addEventListener('click', () => {
    loginModal.style.display = 'block';
  });

  closeButton.addEventListener('click', () => {
    loginModal.style.display = 'none';
  });

  window.addEventListener('click', (event) => {
    if (event.target == loginModal) {
      loginModal.style.display = 'none';
    }
  });

  navLinks.gallery.addEventListener('click', (e) => { e.preventDefault(); loadGallery(); });
  navLinks.upload.addEventListener('click', (e) => {
    e.preventDefault();
    if (!currentUser || !currentUser.token) {
      alert('×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×”×¢×œ×•×ª ×ª×•×¦×¨.');
      loginModal.style.display = 'block';
      return;
    }
    loadUploadPage();
  });
  navLinks.profile.addEventListener('click', (e) => {
    e.preventDefault();
    if (!currentUser) { 
      alert('×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×’×©×ª ×œ×¤×¨×•×¤×™×œ ×”××™×©×™.');
      loginModal.style.display = 'block';
      return; 
    }
    loadProfilePage();
  });
  navReview.addEventListener('click', (e) => {
    e.preventDefault();
    if (!currentUser || !currentUser.user.isEligible) {
      alert('×™×© ×œ×”×’×™×© ×œ×¤×—×•×ª 5 ×ª×•×¦×¨×™× ×›×“×™ ×œ×’×©×ª ×œ×”×¢×¨×›×ª ×¢××™×ª×™×.');
      return;
    }
    loadReviewPage();
  });
  navLinks.admin.addEventListener('click', (e) => {
    e.preventDefault();
    if (!currentUser || !currentUser.user.isAdmin) {
       alert('× ×“×¨×©×•×ª ×”×¨×©××•×ª ×× ×”×œ.');
       return;
    }
    loadAdminPage();
  });

  uploadForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (!currentUser || !currentUser.token) {
      alert('×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×”×¢×œ×•×ª ×ª×•×¦×¨.');
      return;
    }

    const submitButton = uploadForm.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = '×©×•×œ×—...';
    
    const formData = {
      title: uploadForm.title.value,
      instructions: uploadForm.instructions.value,
      targetAudience: uploadForm.targetAudience.value,
      tags: uploadForm.tags.value,
      toolUsed: uploadForm.toolUsed.value,
      artifactLink: uploadForm.artifactLink.value
    };

    const editingId = uploadForm.dataset.editingId;

    if (editingId) {
      // --- UPDATE ARTIFACT ---
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            alert(response.message);
            handleUploadCleanup();
            loadProfilePage();
          } else {
            handleUploadFailure({ message: response.message });
          }
        })
        .withFailureHandler(handleUploadFailure)
        .updateArtifact(currentUser.token, editingId, formData);

    } else {
      // --- CREATE NEW ARTIFACT ---
      const fileInput = document.getElementById('artifactFile');
      const file = fileInput.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const fileData = event.target.result.split(',');
          const base64Data = fileData.length > 1 ? fileData[1] : '';
          google.script.run
            .withSuccessHandler(handleUploadSuccess)
            .withFailureHandler(handleUploadFailure)
            .addNewArtifact(currentUser.token, formData, base64Data, file.name, file.type);
        };
        reader.readAsDataURL(file);
      } else {
        google.script.run
          .withSuccessHandler(handleUploadSuccess)
          .withFailureHandler(handleUploadFailure)
          .addNewArtifact(currentUser.token, formData, null, null, null);
      }
    }
  });

  const handleUploadSuccess = (newArtifact) => {
    alert('×”×ª×•×¦×¨ ×”×•×¢×œ×” ×‘×”×¦×œ×—×”!');
    handleUploadCleanup();
    loadGallery();
  };

  const handleUploadFailure = (error) => {
    alert(`×©×’×™××” ×‘×©×œ×™×—×ª ×”×˜×•×¤×¡: ${error.message}`);
    handleUploadCleanup();
  };

  const handleUploadCleanup = () => {
    const submitButton = uploadForm.querySelector('button[type="submit"]');
    submitButton.disabled = false;
    submitButton.textContent = '×©×œ×™×—×ª ×ª×•×¦×¨';
    uploadForm.reset();
    
    // Cleanup edit mode
    if (uploadForm.dataset.editingId) {
      delete uploadForm.dataset.editingId;
      document.getElementById('upload-title').textContent = '×”×¢×œ××ª ×ª×•×¦×¨ ×—×“×©';
      document.getElementById('artifactLink').disabled = false;
      document.getElementById('artifactFile').disabled = false;
    }
  };

  document.body.addEventListener('click', function(event) {
    // Check for user link click
    const userLink = event.target.closest('.user-link');
    if (userLink) {
        event.preventDefault();
        const userEmail = userLink.dataset.email;
        if (userEmail) {
            showLoader(true);
            google.script.run
                .withSuccessHandler(response => {
                    const data = JSON.parse(response);
                    renderPublicProfile(data);
                    showPage('public-profile');
                    hideSpinner();
                })
                .withFailureHandler(showError)
                .getPublicProfileData(userEmail);
        }
    }
    
    // Check for edit button click
    const editBtn = event.target.closest('.edit-btn');
    if (editBtn) {
        const artifactId = editBtn.dataset.id;
        // TODO: Implement edit functionality
        alert(`×ª×›×•× ×ª ×”×¢×¨×™×›×” ×¢×‘×•×¨ ×ª×•×¦×¨ ${artifactId} ×¢×“×™×™×Ÿ ×‘×¤×™×ª×•×—.`);
    }

    // Check for delete button click
    const deleteBtn = event.target.closest('.delete-btn');
    if (deleteBtn) {
        const artifactId = deleteBtn.dataset.id;
        if (confirm(`×”×× ××ª/×” ×‘×˜×•×—/×” ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×ª×•×¦×¨?`)) {
            showLoader(true);
            google.script.run
                .withSuccessHandler(response => {
                    showLoader(false);
                    if (response.success) {
                        alert('×”×ª×•×¦×¨ × ××—×§ ×‘×”×¦×œ×—×”.');
                        loadProfilePage(); // Refresh the profile page to show the change
                    }
                })
                .withFailureHandler(showError)
                .deleteArtifact(currentUser.token, artifactId);
        }
    }
  });

  document.body.addEventListener('submit', (e) => {
    if (e.target.classList.contains('review-form')) {
      e.preventDefault();
      const form = e.target;
      const artifactId = form.dataset.artifactId;

      // Extract value from selected radio button for each star rating group
      const scoreDesign = form.querySelector('input[name="scoreDesign"]:checked')?.value;
      const scoreTechnical = form.querySelector('input[name="scoreTechnical"]:checked')?.value;
      const scorePedagogy = form.querySelector('input[name="scorePedagogy"]:checked')?.value;
      
      const reviewData = {
        artifactId: artifactId,
        scoreDesign: scoreDesign,
        scoreTechnical: scoreTechnical,
        scorePedagogy: scorePedagogy,
        comments: form.comments.value,
      };

      if (!scoreDesign || !scoreTechnical || !scorePedagogy) {
        alert('×™×© ×œ×“×¨×’ ××ª ×›×œ ×”×§×¨×™×˜×¨×™×•× ×™×.');
        return;
      }

      showLoader(true);
      google.script.run
        .withSuccessHandler(response => {
          alert('×”×”×¢×¨×›×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!');
          loadReviewPage(); // Refresh the review page
        })
        .withFailureHandler(err => {
          alert(`×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×¢×¨×›×”: ${err.message}`);
          showLoader(false);
        })
        .submitReview(currentUser.token, reviewData);
    }
  });

  // --- Rendering Functions ---

  const renderPublicProfile = (data) => {
    const container = document.getElementById('public-profile-artifacts-container');
    const title = document.getElementById('public-profile-title');
    container.innerHTML = '';
    title.textContent = `×”×ª×•×¦×¨×™× ×©×œ ${data.email}`;
    
    if (!data.artifacts || data.artifacts.length === 0) {
        container.innerHTML = '<p>×œ××©×ª××© ×–×” ××™×Ÿ ×¢×“×™×™×Ÿ ×ª×•×¦×¨×™× ×¦×™×‘×•×¨×™×™×.</p>';
        return;
    }

    data.artifacts.forEach(artifact => {
        const card = document.createElement('div');
        card.className = 'artifact-card';
        // Using the same card structure as the main gallery for consistency
        card.innerHTML = `
          <div class="image-container">
            ${(artifact.previewImageUrl && artifact.previewImageUrl.startsWith('http')) 
              ? `<img src="${artifact.previewImageUrl}" alt="×ª×¦×•×’×” ××§×“×™××” ×©×œ ${artifact.title}" class="artifact-image" onerror="this.style.display='none'">` 
              : ''}
          </div>
          ${artifact.targetAudience ? `<div class="card-chip">${artifact.targetAudience}</div>` : ''}
          <div class="card-content">
            <h3>${artifact.title || '×œ×œ× ×›×•×ª×¨×ª'}</h3>
            <p>${artifact.instructions || ''}</p>
            <p><strong><small>×›×œ×™:</small></strong> ${artifact.toolUsed || '×œ× ×¦×•×™×Ÿ'}</p>
            <div class="actions">
               <a href="${artifact.artifactLink}" target="_blank" class="icon-button" title="×¦×¤×” ×‘×ª×•×¦×¨">
                  <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
               </a>
            </div>
          </div>
        `;
        container.appendChild(card);
    });
  };

  // --- Global Helper Functions ---
  // Spinner functions removed - using showLoader instead

  const showError = (error) => {
      hideSpinner();
      console.error('Operation failed:', error);
      alert('××™×¨×¢×” ×©×’×™××”: ' + error.message);
  };

  // --- INITIALIZATION ---
  initializeApp();

  // Handle Admin tab click
  navLinks.admin.addEventListener('click', (e) => {
    e.preventDefault();
    showLoader(true);
    google.script.run
      .withSuccessHandler(response => {
        const data = JSON.parse(response);
        renderAdminDashboard(data);
        hideSpinner();
        showPage('admin');
      })
      .withFailureHandler(error => {
        hideSpinner();
        showError(error);
        showPage('gallery'); // Go back to gallery on error
      })
      .getAdminDashboardData();
  });

  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const username = e.target.username.value;
    const password = e.target.password.value;
    const statusDiv = document.getElementById('login-status');
    statusDiv.textContent = '××ª×—×‘×¨...';

    google.script.run
      .withSuccessHandler(response => {
        if (response.success) {
          handleLoginSuccess(response);
        } else {
          statusDiv.textContent = `×©×’×™××ª ×”×ª×—×‘×¨×•×ª: ${response.message}`;
        }
      })
      .withFailureHandler(err => {
        console.error('Login failed:', err);
        statusDiv.textContent = `×©×’×™××”: ${err.message}`;
      })
      .loginUser(username, password);
  });

  const handleLoginSuccess = (loginData) => {
    currentUser = {
      token: loginData.token,
      user: loginData.user
    };

    // Update UI
    const userInfoDiv = document.getElementById('user-info');
    userInfoDiv.innerHTML = `
      <span>×©×œ×•×, ${currentUser.user.fullName}</span>
      <button id="logout-button" class="button-secondary">×”×ª× ×ª×§×•×ª</button>
    `;
    document.getElementById('logout-button').addEventListener('click', handleLogout);

    // Show relevant nav links
    navLinks.upload.style.display = 'inline-block';
    navLinks.profile.style.display = 'inline-block';
    if (currentUser.user.isAdmin) {
      navLinks.admin.style.display = 'inline-block';
    }
    if (currentUser.user.isEligible) {
      navReview.style.display = 'inline-block';
    }
    
    // Close modal
    loginModal.style.display = 'none';
    loginForm.reset();
    document.getElementById('login-status').textContent = '';
  };

  const handleLogout = () => {
    if (currentUser && currentUser.token) {
      google.script.run.logoutUser(currentUser.token);
    }
    currentUser = null;
    
    // Update UI
    const userInfoDiv = document.getElementById('user-info');
    userInfoDiv.innerHTML = `<button id="login-button" class="button-secondary">×”×ª×—×‘×¨×•×ª</button>`;
    document.getElementById('login-button').addEventListener('click', () => {
      loginModal.style.display = 'block';
    });

    // Hide nav links
    navLinks.upload.style.display = 'none';
    navLinks.profile.style.display = 'none';
    navLinks.admin.style.display = 'none';
    navReview.style.display = 'none';

    // Go back to gallery view
    loadGallery();
  };

  const handleEditArtifactClick = (artifactId) => {
    showLoader(true);
    google.script.run
      .withSuccessHandler(artifactData => {
        // Populate the upload form
        uploadForm.reset();
        uploadForm.dataset.editingId = artifactId; // Mark as editing

        document.getElementById('upload-title').textContent = '×¢×¨×™×›×ª ×ª×•×¦×¨';
        document.getElementById('title').value = artifactData.title || '';
        document.getElementById('instructions').value = artifactData.instructions || '';
        document.getElementById('targetAudience').value = artifactData.targetAudience || '';
        document.getElementById('tags').value = artifactData.tags || '';
        document.getElementById('toolUsed').value = artifactData.toolUsed || '';
        
        // For simplicity, disable changing the link/file when editing
        const artifactLinkInput = document.getElementById('artifactLink');
        const artifactFileInput = document.getElementById('artifactFile');
        artifactLinkInput.value = artifactData.artifactLink || '';
        artifactLinkInput.disabled = true;
        artifactFileInput.disabled = true;

        showPage('page-upload');
        showLoader(false);
      })
      .withFailureHandler(err => {
        showLoader(false);
        alert(`×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×”×ª×•×¦×¨: ${err.message}`);
      })
      .getArtifactDetails(currentUser.token, artifactId);
  };
  
  /**
   * Renders the profile page with user data and artifacts.
   * @param {Object} data The profile data from the server.
   */
  const renderProfilePage = (data) => {
    showPage('page-profile');
    const profileContent = document.getElementById('profile-content');
    const userStatsDiv = document.getElementById('user-stats');
    const profileArtifactsContainer = document.getElementById('profile-artifacts');

    // Update user stats
    userStatsDiv.innerHTML = `
      <h3>×¡×˜×˜×™×¡×˜×™×§×•×ª</h3>
      <p>×ª×•×¦×¨×™× ×©×”×’×©×ª: ${data.user.submissionsCount || 0}</p>
      <p>×”×¢×¨×›×•×ª ×©×‘×™×¦×¢×ª: ${data.user.reviewsCompletedCount || 0}</p>
      <p>×¡×˜×˜×•×¡: ${data.user.isEligible ? '×–×›××™ ×œ×”×¢×¨×›×ª ×¢××™×ª×™×' : '×œ× ×–×›××™ ×¢×“×™×™×Ÿ'}</p>
    `;

    // Clear and populate artifacts
    profileArtifactsContainer.innerHTML = '';
    
    if (!data.artifacts || data.artifacts.length === 0) {
      profileArtifactsContainer.innerHTML = '<p>×¢×“×™×™×Ÿ ×œ× ×”×’×©×ª ×ª×•×¦×¨×™×.</p>';
      return;
    }

    data.artifacts.forEach(artifact => {
      const card = document.createElement('div');
      card.className = 'artifact-card';
      card.innerHTML = `
        <h4>${artifact.title}</h4>
        <p class="artifact-meta">
          <span class="chip audience-${artifact.targetAudience?.replace(/\s+/g, '-')}">${artifact.targetAudience}</span>
          <span class="artifact-date">${new Date(artifact.submissionTimestamp).toLocaleDateString('he-IL')}</span>
        </p>
        <p class="artifact-description">${artifact.instructions}</p>
        <div class="actions">
          <button class="button-icon edit-btn" data-id="${artifact.id}" title="×¢×¨×™×›×”">âœï¸</button>
          <button class="button-icon delete-btn" data-id="${artifact.id}" title="××—×™×§×”">ğŸ—‘ï¸</button>
          <a href="${artifact.artifactLink}" target="_blank" class="button-icon view-btn" title="×¦×¤×™×™×”">ğŸ‘ï¸</a>
        </div>
      `;
      profileArtifactsContainer.appendChild(card);
    });

    // Attach event listeners to the new buttons
    profileArtifactsContainer.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => handleEditArtifactClick(btn.dataset.id));
    });
    
    profileArtifactsContainer.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => deleteArtifact(btn.dataset.id));
    });
  };

  /**
   * Renders the admin dashboard with user and artifact statistics.
   * @param {Object} data The admin dashboard data from the server.
   */
  const renderAdminPage = (data) => {
    showPage('page-admin');
    const adminContent = document.getElementById('admin-content');
    
    if (!data || typeof data !== 'object') {
      adminContent.innerHTML = '<p>×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×× ×”×œ.</p>';
      return;
    }
    
    adminContent.innerHTML = `
      <h2>×“×©×‘×•×¨×“ ×× ×”×œ</h2>
      
      <div class="dashboard-stats">
        <div class="stat-card">
          <h3>×¡×š ×”××©×ª××©×™×</h3>
          <p class="stat-number">${data.totalUsers || 0}</p>
        </div>
        <div class="stat-card">
          <h3>×¡×š ×”×ª×•×¦×¨×™×</h3>
          <p class="stat-number">${data.totalArtifacts || 0}</p>
        </div>
        <div class="stat-card">
          <h3>××©×ª××©×™× ×–×›××™×</h3>
          <p class="stat-number">${data.eligibleUsers || 0}</p>
        </div>
      </div>

      <div class="admin-tables">
        <div class="admin-section">
          <h3>××©×ª××©×™×</h3>
          <table class="admin-table">
            <thead>
              <tr>
                <th>×©× ××œ×</th>
                <th>××™×™×œ</th>
                <th>×ª×•×¦×¨×™×</th>
                <th>×”×¢×¨×›×•×ª</th>
                <th>×–×›××•×ª</th>
              </tr>
            </thead>
            <tbody>
              ${(data.users || []).map(user => `
                <tr>
                  <td>${user.fullName || ''}</td>
                  <td>${user.username || ''}</td>
                  <td>${user.submissionsCount || 0}</td>
                  <td>${user.reviewsCompletedCount || 0}</td>
                  <td>${user.isEligible ? 'âœ…' : 'âŒ'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="admin-section">
          <h3>×ª×•×¦×¨×™×</h3>
          <table class="admin-table">
            <thead>
              <tr>
                <th>×›×•×ª×¨×ª</th>
                <th>×™×•×¦×¨</th>
                <th>×§×”×œ ×™×¢×“</th>
                <th>×ª××¨×™×š</th>
              </tr>
            </thead>
            <tbody>
              ${(data.artifacts || []).map(artifact => `
                <tr>
                  <td>${artifact.title || ''}</td>
                  <td>${artifact.submitterUsername || ''}</td>
                  <td>${artifact.targetAudience || ''}</td>
                  <td>${artifact.submissionTimestamp ? new Date(artifact.submissionTimestamp).toLocaleDateString('he-IL') : ''}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  };

});
</script> 