<script>
document.addEventListener('DOMContentLoaded', function() {
  // =================================================================
  //      STATE MANAGEMENT
  // =================================================================
  const state = {
    currentUser: null,
    artifacts: [],
    isLoading: true,
    currentView: 'gallery', // gallery, submission, reviews, profile, admin
  };

  // =================================================================
  //      DOM ELEMENTS
  // =================================================================
  const app = document.getElementById('app');
  const userActions = document.getElementById('user-actions');
  const mainContent = document.querySelector('main');
  const allViews = mainContent.querySelectorAll('[id$="-view"]');
  const allNavLinks = document.querySelectorAll('.nav-link');
  const artifactsGrid = document.getElementById('artifacts-grid');

  // Modal elements
  const loginModal = document.getElementById('login-modal');
  const registerModal = document.getElementById('register-modal');
  
  // =================================================================
  //      RENDERING LOGIC
  // =================================================================
  function render() {
    // Render loading state
    if (state.isLoading) {
      app.classList.add('loading');
      return;
    }
    app.classList.remove('loading');

    // Render User State (Header)
    renderUser();

    // Render current view
    allViews.forEach(view => view.style.display = 'none');
    document.getElementById(`${state.currentView}-view`).style.display = 'block';

    // Update active nav link
    allNavLinks.forEach(link => {
      link.classList.remove('active');
      if (link.id === `nav-${state.currentView}`) {
        link.classList.add('active');
      }
    });

    // Render content for specific views
    if (state.currentView === 'gallery') {
      renderGallery();
    }
    // Add other view renderers here as they are built
  }

  function renderUser() {
    userActions.innerHTML = '';
    const loggedInNavs = ['nav-add-artifact', 'nav-reviews', 'nav-profile', 'nav-logout'];
    
    if (state.currentUser) {
      // Show appropriate nav links
      loggedInNavs.forEach(id => { 
        const el = document.getElementById(id);
        if(el) el.style.display = 'flex';
      });
      document.getElementById('nav-admin').style.display = state.currentUser.isAdmin ? 'flex' : 'none';

      const avatarInitial = state.currentUser.fullName ? state.currentUser.fullName.charAt(0) : '?';
      userActions.innerHTML = `
        <div id="user-info">
            <span>${state.currentUser.fullName}</span>
            <div id="user-avatar">${avatarInitial}</div>
        </div>
      `;
    } else {
      // Hide nav links and show login button
      loggedInNavs.forEach(id => {
         const el = document.getElementById(id);
         if(el) el.style.display = 'none';
      });
      document.getElementById('nav-admin').style.display = 'none';
      userActions.innerHTML = `<button id="login-btn-header">התחברות / הרשמה</button>`;
    }
  }

  function renderGallery() {
    artifactsGrid.innerHTML = '';
    if (!state.artifacts || state.artifacts.length === 0) {
      artifactsGrid.innerHTML = '<p>עדיין לא הוגשו תוצרים לגלריה.</p>';
      return;
    }

    state.artifacts.forEach(artifact => {
      const card = document.createElement('div');
      card.className = 'artifact-card';

      const authorFullNameStr = String(artifact.authorFullName || '');
      const avatarInitial = authorFullNameStr ? authorFullNameStr.charAt(0) : '?';
      const tagsHtml = (artifact.tags || '').split(',').map(tag => tag.trim() ? `<div class="tag">${tag.trim()}</div>` : '').join('');

      card.innerHTML = `
        <div class="card-header">
            <img src="${artifact.previewImageUrl}" class="preview-image" alt="${artifact.title}" onerror="this.onerror=null;this.style.display='none';">
            <div class="file-type-badge">${artifact.artifactType || 'קישור'}</div>
            <div class="like-button">
                <span class="icon">♡</span>
                <span class="count">${artifact.likes || 0}</span>
            </div>
        </div>
        <div class="card-content">
            <h3>${artifact.title}</h3>
            <p class="description">${artifact.instructions || ''}</p>
            <div class="author-info">
                <div class="author-avatar">${avatarInitial}</div>
                <div class="author-details">
                    <p class="author-name">${authorFullNameStr || 'אלמוני'}</p>
                    <p class="tool-used">${artifact.toolUsed || ''}</p>
                </div>
            </div>
            <div class="card-tags">
                ${tagsHtml}
            </div>
        </div>
      `;
      artifactsGrid.appendChild(card);
    });
  }

  // =================================================================
  //      EVENT LISTENERS & LOGIC
  // =================================================================
  
  function closeModal(modal) {
    if (modal) modal.classList.remove('show');
  }

  function setupEventListeners() {
    // Navigation
    document.querySelector('nav').addEventListener('click', (e) => {
      const navLink = e.target.closest('.nav-link');
      if (!navLink) return;
      e.preventDefault();

      let newView = navLink.id.replace('nav-', '');

      if (newView === 'logout') {
        google.script.run
          .withSuccessHandler(() => {
            state.currentUser = null;
            state.currentView = 'gallery';
            render();
            loginModal.classList.add('show');
          })
          .withFailureHandler(onFailure)
          .logoutUser();
      } else {
        if (newView === 'reviews') newView = 'review'; // Fix for ID mismatch
        state.currentView = newView;
        render();
      }
    });

    // Modals
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    
    document.body.addEventListener('click', function(e) {
      if (e.target.id === 'login-btn-header' || e.target.id === 'show-login') {
        e.preventDefault();
        registerModal.classList.remove('show');
        loginModal.classList.add('show');
      }
      if (e.target.id === 'show-register') {
        e.preventDefault();
        loginModal.classList.remove('show');
        registerModal.classList.add('show');
      }
    });
    
    [loginModal, registerModal].forEach(modal => {
        modal.querySelector('.close-btn').addEventListener('click', () => closeModal(modal));
        modal.addEventListener('click', (e) => {
            if(e.target === modal) closeModal(modal);
        });
    });

    // Auth forms
    loginForm.addEventListener('submit', handleLogin);
    registerForm.addEventListener('submit', handleRegister);
  }

  function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    google.script.run
        .withSuccessHandler(onAuthSuccess)
        .withFailureHandler(onFailure)
        .loginUser(username, password);
  }

  function handleRegister(e) {
    e.preventDefault();
    const userDetails = {
      username: document.getElementById('register-username').value,
      fullName: document.getElementById('register-fullname').value,
      email: document.getElementById('register-email').value,
      password: document.getElementById('register-password').value,
      question: document.getElementById('register-security-question').value,
      answer: document.getElementById('register-security-answer').value,
    };
    google.script.run
        .withSuccessHandler(onAuthSuccess)
        .withFailureHandler(onFailure)
        .registerUser(userDetails);
  }
  
  function onAuthSuccess(response) {
      if(response.success === false) { // For registration which returns {success, message}
        onFailure(new Error(response.message));
        return;
      }
      // For login, response is the user object
      closeModal(loginModal);
      closeModal(registerModal);
      fetchInitialData();
  }
  
  function onFailure(error) {
    alert(`שגיאה: ${error.message}`);
    // hide loading indicator
  }

  // =================================================================
  //      INITIALIZATION
  // =================================================================
  function fetchInitialData() {
    state.isLoading = true;
    render();
    google.script.run
      .withSuccessHandler(data => {
        state.currentUser = data.user;
        state.artifacts = data.gallery;
        // load other data...
        state.isLoading = false;
        if (!state.currentUser) {
            loginModal.classList.add('show');
        }
        render();
      })
      .withFailureHandler(onFailure)
      .getInitialAppData();
  }

  setupEventListeners();
  fetchInitialData();
});
</script> 