<script>
document.addEventListener('DOMContentLoaded', function() {
  // =================================================================
  //      STATE MANAGEMENT
  // =================================================================
  const state = {
    currentUser: null,
    artifacts: [],
    mySubmissions: [],
    isLoading: true,
    currentView: 'gallery', // gallery, submission, review, profile, admin
    previewFile: null
  };

  // =================================================================
  //      DOM ELEMENTS
  // =================================================================
  const app = document.getElementById('app');
  const userActions = document.getElementById('user-actions');
  const mainContent = document.querySelector('main');
  const allViews = mainContent.querySelectorAll('[id$="-view"]');
  const allNavLinks = document.querySelectorAll('.nav-link');
  const artifactsGrid = document.getElementById('artifacts-grid');
  const myArtifactsGrid = document.getElementById('my-artifacts-grid');

  // Modal elements
  const loginModal = document.getElementById('login-modal');
  const registerModal = document.getElementById('register-modal');
  
  // =================================================================
  //      RENDERING LOGIC
  // =================================================================
  function render() {
    if (state.isLoading) {
      app.classList.add('loading'); // You can add CSS for a loading spinner
      return;
    }
    app.classList.remove('loading');

    renderUser();

    allViews.forEach(view => view.style.display = 'none');
    const currentViewEl = document.getElementById(`${state.currentView}-view`);
    if(currentViewEl) {
      currentViewEl.style.display = 'block';
    }

    allNavLinks.forEach(link => {
      link.classList.remove('active');
      const navId = state.currentView === 'submission-form' ? 'nav-add-artifact' : `nav-${state.currentView}`;
      if (link.id === navId) {
        link.classList.add('active');
      }
    });

    if (state.currentView === 'gallery') {
      renderArtifacts(artifactsGrid, state.artifacts, "עדיין לא הוגשו תוצרים לגלריה.");
    } else if (state.currentView === 'profile') {
      renderArtifacts(myArtifactsGrid, state.mySubmissions, "עדיין לא הגשת תוצרים.");
    }
  }

  function renderUser() {
    userActions.innerHTML = '';
    const loggedInNavs = ['nav-add-artifact', 'nav-reviews', 'nav-profile', 'nav-logout'];
    
    if (state.currentUser) {
      // Show appropriate nav links
      loggedInNavs.forEach(id => { 
        const el = document.getElementById(id);
        if(el) el.style.display = 'flex';
      });
      document.getElementById('nav-admin').style.display = state.currentUser.isAdmin ? 'flex' : 'none';

      const avatarInitial = state.currentUser.fullName ? state.currentUser.fullName.charAt(0) : '?';
      userActions.innerHTML = `
        <div id="user-info">
            <span>${state.currentUser.fullName}</span>
            <div id="user-avatar">${avatarInitial}</div>
        </div>
      `;
    } else {
      // Hide nav links and show login button
      loggedInNavs.forEach(id => {
         const el = document.getElementById(id);
         if(el) el.style.display = 'none';
      });
      document.getElementById('nav-admin').style.display = 'none';
      userActions.innerHTML = `<button id="login-btn-header">התחברות / הרשמה</button>`;
    }
  }

  function renderArtifacts(gridElement, artifacts, emptyMessage) {
    if (!gridElement) return;
    gridElement.innerHTML = '';
    if (!artifacts || artifacts.length === 0) {
      gridElement.innerHTML = `<p>${emptyMessage}</p>`;
      return;
    }
    artifacts.forEach(artifact => {
      const card = createArtifactCard(artifact);
      gridElement.appendChild(card);
    });
  }

  function createArtifactCard(artifact) {
    const card = document.createElement('div');
    card.className = 'artifact-card';
    const authorFullNameStr = String(artifact.authorFullName || artifact.submitterUsername || '');
    const avatarInitial = authorFullNameStr ? authorFullNameStr.charAt(0) : '?';
    const tagsHtml = (artifact.tags || '').split(',').map(tag => tag.trim() ? `<div class="tag">${tag.trim()}</div>` : '').join('');
    
    card.innerHTML = `
      <div class="card-header">
          <img src="${artifact.previewImageUrl}" class="preview-image" alt="${artifact.title}" onerror="this.onerror=null;this.style.display='none';">
          <div class="file-type-badge">${artifact.artifactType || 'קישור'}</div>
          <div class="like-button">
              <span class="icon">♡</span>
              <span class="count">${artifact.likes || 0}</span>
          </div>
      </div>
      <div class="card-content">
          <h3>${artifact.title}</h3>
          <p class="description">${artifact.instructions || ''}</p>
          <div class="author-info">
              <div class="author-avatar">${avatarInitial}</div>
              <div class="author-details">
                  <p class="author-name">${authorFullNameStr || 'אלמוני'}</p>
                  <p class="tool-used">${artifact.toolUsed || ''}</p>
              </div>
          </div>
          <div class="card-tags">
              ${tagsHtml}
          </div>
      </div>
    `;
    return card;
  }

  // =================================================================
  //      EVENT LISTENERS & LOGIC
  // =================================================================
  function closeModal(modal) {
    if (modal) modal.classList.remove('show');
  }

  function setupEventListeners() {
    document.querySelector('nav').addEventListener('click', (e) => {
      const navLink = e.target.closest('.nav-link');
      if (!navLink) return;
      e.preventDefault();
      
      let newView = navLink.id.replace('nav-', '');
      
      if (newView === 'logout') {
        handleLogout();
      } else {
        // Map old IDs to new view names
        if (newView === 'add-artifact') newView = 'submission-form'; 
        if (newView === 'reviews') newView = 'review';
        
        state.currentView = newView;
        render();
      }
    });

    // Modals
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    
    document.body.addEventListener('click', function(e) {
      if (e.target.id === 'login-btn-header' || e.target.id === 'show-login') {
        e.preventDefault();
        registerModal.classList.remove('show');
        loginModal.classList.add('show');
      }
      if (e.target.id === 'show-register') {
        e.preventDefault();
        loginModal.classList.remove('show');
        registerModal.classList.add('show');
      }
    });
    
    [loginModal, registerModal].forEach(modal => {
        modal.querySelector('.close-btn').addEventListener('click', () => closeModal(modal));
        modal.addEventListener('click', (e) => {
            if(e.target === modal) closeModal(modal);
        });
    });

    // Auth forms
    loginForm.addEventListener('submit', handleLogin);
    registerForm.addEventListener('submit', handleRegister);

    // Submission Form Listeners
    const submissionForm = document.getElementById('submission-form');
    const imageUploadArea = document.getElementById('image-upload-area');
    const imageUploadInput = document.getElementById('image-upload-input');
    
    if(imageUploadArea) {
      imageUploadArea.addEventListener('click', () => imageUploadInput.click());
      imageUploadInput.addEventListener('change', handleFileSelect);
      // Add drag/drop listeners if you want
    }
    if(submissionForm) {
      submissionForm.addEventListener('submit', handleSubmitArtifact);
    }
  }

  function handleLogout() {
    google.script.run.withSuccessHandler(() => {
        state.currentUser = null;
        state.currentView = 'gallery';
        fetchInitialData(); // Re-fetch public data
      }).logoutUser();
  }

  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    state.previewFile = file;
    const reader = new FileReader();
    reader.onload = function(event) {
        document.getElementById('image-preview').src = event.target.result;
        document.getElementById('image-preview').style.display = 'block';
        document.getElementById('image-upload-prompt').style.display = 'none';
    };
    reader.readAsDataURL(file);
  }

  function handleSubmitArtifact(e) {
    e.preventDefault();
    if (!state.previewFile) {
      alert('יש להעלות תמונה מייצגת.');
      return;
    }

    const submitBtn = document.getElementById('submit-artifact-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'מעלה...';

    const fileReader = new FileReader();
    fileReader.onload = (event) => {
      const fileData = {
        base64: event.target.result.split(',')[1],
        type: state.previewFile.type,
        name: state.previewFile.name
      };
      
      const formData = {
        title: document.getElementById('submission-title').value,
        instructions: document.getElementById('submission-instructions').value,
        toolUsed: document.getElementById('submission-tool').value,
        artifactType: document.getElementById('submission-artifact-type').value,
        artifactLink: document.getElementById('submission-artifact-link').value,
        targetAudience: document.getElementById('submission-target-audience').value,
        tags: document.getElementById('submission-tags').value
      };

      google.script.run
        .withSuccessHandler(onSubmitSuccess)
        .withFailureHandler(onFailure)
        .submitArtifact(formData, fileData);
    };
    fileReader.readAsDataURL(state.previewFile);
  }

  function onSubmitSuccess(result) {
    if (result.success) {
      alert('התוצר הוגש בהצלחה!');
      document.getElementById('submission-form').reset();
      document.getElementById('image-preview').style.display = 'none';
      document.getElementById('image-upload-prompt').style.display = 'block';
      state.previewFile = null;
      state.currentView = 'profile'; // Switch to profile to see the new artifact
      fetchInitialData();
    } else {
      onFailure(new Error(result.message || "שגיאה לא ידועה."));
    }
  }

  function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    google.script.run
        .withSuccessHandler(onAuthSuccess)
        .withFailureHandler(onFailure)
        .loginUser(username, password);
  }

  function handleRegister(e) {
    e.preventDefault();
    const userDetails = {
      username: document.getElementById('register-username').value,
      fullName: document.getElementById('register-fullname').value,
      email: document.getElementById('register-email').value,
      password: document.getElementById('register-password').value,
      question: document.getElementById('register-security-question').value,
      answer: document.getElementById('register-security-answer').value,
    };
    google.script.run
        .withSuccessHandler(onAuthSuccess)
        .withFailureHandler(onFailure)
        .registerUser(userDetails);
  }
  
  function onAuthSuccess(response) {
      if(response.success === false) { // For registration which returns {success, message}
        onFailure(new Error(response.message));
        return;
      }
      // For login, response is the user object
      closeModal(loginModal);
      closeModal(registerModal);
      fetchInitialData();
  }
  
  function onFailure(error) {
    alert(`שגיאה: ${error.message}`);
    // hide loading indicator
  }

  // =================================================================
  //      INITIALIZATION
  // =================================================================
  function fetchInitialData() {
    state.isLoading = true;
    render();
    google.script.run
      .withSuccessHandler(data => {
        state.currentUser = data.user;
        state.artifacts = data.gallery;
        state.mySubmissions = data.mySubmissions;
        state.isLoading = false;
        
        // If user is not logged in and there's no public content, show login
        if (!state.currentUser && window.location.hash !== '#guest') {
            loginModal.classList.add('show');
        }
        
        const submitBtn = document.getElementById('submit-artifact-btn');
        if(submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'הגשת תוצר';
        }

        render();
      })
      .withFailureHandler(onFailure)
      .getInitialAppData();
  }

  setupEventListeners();
  fetchInitialData();
});
</script> 